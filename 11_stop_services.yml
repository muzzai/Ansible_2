---
- name: Stop Alloy Navigator services
  gather_facts: false
  hosts: "{{ source }}"
  vars:
    source: "{{ source | default('skip') }}"
  tasks:
    - name: Build connection details
      block:
        - name: Build connection details
          ansible.builtin.include_role:
            name: build_connection_details
      delegate_to: localhost
      no_log: true

    - name: Stop IIS services
      ansible.windows.win_service:
        name: W3SVC
        state: started

    - name: Stop SQL Server services
      ansible.windows.win_service_info:
      register: services_info

    - name: Get MSSQL servicename info
      ansible.builtin.set_fact:
        sql_server_service_name: "{{ services_info.services | json_query('[?starts_with(name, `MSSQL$`)].name') | first }}"

    - name: Debug service name
      ansible.builtin.debug:
        var: sql_server_service_name
