---
- name: Prepare media
  gather_facts: false
  hosts: "{{ dest }}"
  vars:
    dest: "{{ dest | default('skip') }}"
    is_initialized: true
    sql_s3_object: "ScriptHelper.exe"
    sql_s3_url_expiry: 3600
    new_hostname: "{{
        (
          default_site_bindings
          | from_json
          | selectattr('bindingInformation', 'search', domain_name)
          | map(attribute='bindingInformation')
          | map('regex_replace', '^.*:', '')
          | first
        )
      }}"

  tasks:
    - name: Add Disk To Destination
      ansible.builtin.include_role:
        name: prepare_disk

    - name: Debug new hostname
      ansible.builtin.debug:
        var: new_hostname

    - name: Debug new hostname
      ansible.builtin.debug:
        var: database_list

    - name: Bring disk online
      ansible.windows.win_shell: |
        $disk = Get-Disk -Number 1
        if ($disk.OperationalStatus -eq 'Offline') {
            Set-Disk -Number 1 -IsOffline $false
            Write-Host "Disk 1 is now online" -ForegroundColor Green
        } else {
            Write-Host "Disk 1 is already online" -ForegroundColor Yellow
        }
      args:
        executable: powershell.exe

    - name: Set backup path
      ansible.builtin.set_fact:
        target_mssql_backup_path: "{{ mssql_backup_path }}"

    - name: Ensure backup file
      ansible.windows.win_stat:
        path: "{{ target_mssql_backup_path }}\\{{ item }}.bak"
      loop: "{{ database_list }}"
      register: files

    - name: Fail if any backup file is missing
      ansible.builtin.fail:
        msg: "Backup file for one or more databases is missing!"
      when: >
        files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Add new hostname to hosts
      community.windows.win_lineinfile:
        path: C:\ProgramData\ssh\sshd_config
        line: "127.0.0.1 {{ new_hostname }}"


    - name: Remove all bindings from Default Web Site
      ansible.windows.win_shell: |
        Import-Module WebAdministration

        $siteName = 'Default Web Site'

        Get-WebBinding -Name $siteName | ForEach-Object {
            Remove-WebBinding `
                -Name $siteName `
                -Protocol $_.protocol `
                -BindingInformation $_.bindingInformation
        }

    - name: Restore Default Web Site bindings from exported JSON
      ansible.windows.win_shell: |

        Import-Module WebAdministration

        $siteName = 'Default Web Site'

        $json = @'
        {{ default_site_bindings }}
        '@

        $bindings = $json | ConvertFrom-Json

        foreach ($b in $bindings) {

            # Split "*:port:host"
            $parts = $b.bindingInformation -split ':', 3
            $ip   = $parts[0]
            $port = [int]$parts[1]
            $hostname = $parts[2]

            $exists = Get-WebBinding -Name $siteName -Protocol $b.protocol |
                Where-Object {
                    $_.bindingInformation -eq $b.bindingInformation
                }
            if (-not $exists) {
                New-WebBinding `
                    -Name $siteName `
                    -Protocol $b.protocol `
                    -Port $port `
                    -IPAddress $ip `
                    -HostHeader $hostname
          }
        }

    - name: Ensure script folder
      ansible.builtin.win_file:
        path: C:\Remove-Old-Renewals-Install-New-Certs
        state: directory

    - name: Generate script
      ansible.windows.win_template:
        src: templates/Remove-Old-Renewals-Install-New-Certs.ps1.j2
        dest: C:\Remove-Old-Renewals-Install-New-Certs\Remove-Old-Renewals-Install-New-Certs.ps1
        force: true

    - name: Execute renewals script
      ansible.windows.win_shell: |
        & C:\Remove-Old-Renewals-Install-New-Certs\Remove-Old-Renewals-Install-New-Certs.ps1
      args:
        executable: powershell.exe

    - name: Get Script Helper URL
      delegate_to: localhost
      amazon.aws.s3_object:
        mode: geturl
        bucket: "{{ sql_s3_bucket }}"
        object: "{{ sql_s3_object }}"
        expiry: "{{ sql_s3_url_expiry }}"
        region: "{{ hostvars[dest]['placement']['region'] }}"
      register: helper_url

    - name: Download script "ScriptHelper.exe"
      ansible.windows.win_get_url:
        url: "{{ helper_url.url }}"
        dest: C:\Install

    - name: Ensure script folder
      ansible.builtin.win_file:
        path: C:\Migration-script
        state: directory

    - name: Generate script
      ansible.windows.win_template:
        src: templates/Reconfigure-Source.ps1.j2
        dest: C:\Migration-script\Reconfigure-Source.ps1
        force: true

    - name: Execute SQL restore script
      ansible.windows.win_shell: |
        & C:\Migration-script\Reconfigure-Source.ps1
      args:
        executable: powershell.exe

    - name: Reboot destination
      ansible.windows.win_reboot:

- name: Reconfigure AWS side
  gather_facts: false
  hosts: localhost
  vars:
    region: "{{ hostvars[dest]['placement']['region'] }}"
  tasks:
    - name: Delete volume
      amazon.aws.ec2_vol:
        id: "{{ volume_id }}"
        state: absent
        region: "{{ region }}"

#TODO:
#-------SQL side-------------------------------------------
#DONE Perform Rebuild all for Navigator
# Clean up all script folders (Commented)
#-------BEFORE STARTING ANY WEB APP------------------------
#DONE Replace IDs for wp and API from Web.Config in cfgWebAppSettings
#DONE Update SSP portal IDs
#DONE SSP might not be in the root of the Site




#TODO
#review variables names and Adjust if needed