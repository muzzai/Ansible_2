$ServerInstance = "{{ ansible_host }},51967"
$AN_Database = "{{ AN_Database }}"
$AD_Database = "{{ AD_Database }}"
$SaUserName = "{{ source_SaUserName }}"
$SaPassword = "{{ source_SaPassword }}"
$VolumeFolder = "{{ VolumeFolder }}"

# Detect SQL Server edition
Write-Output "Detecting SQL server edition"
$Engine = Invoke-Sqlcmd -ServerInstance $ServerInstance -Username $SaUserName -Password $SaPassword -Query "SELECT SERVERPROPERTY('EngineEdition') AS [Edition]"
Write-Output "SQL server edition: $($Engine.Edition)"

if ($Engine.Edition -ne 4) {
    $CompressionOption = "ON"
} else {
    $CompressionOption = "DEFAULT"
}
Write-Output "Compression Option: $CompressionOption"

# Prepare temp folder
$TempFolder = "C:\Migration"
Remove-Item $TempFolder -Recurse -Force -ErrorAction SilentlyContinue
New-Item -Path $TempFolder -ItemType Directory | Out-Null

function BackupDatabase {
    param(
        [string]$Database
    )

    Write-Output "Setting single user mode for $Database"
    Invoke-Sqlcmd -ServerInstance $ServerInstance -Username $SaUserName -Password $SaPassword -Query "ALTER DATABASE [$Database] SET SINGLE_USER WITH ROLLBACK IMMEDIATE"

    Write-Output "Backing up database $Database"
    $BackupFile = Join-Path $TempFolder "$Database.bak"
    $BackupQuery = @"
BACKUP DATABASE [$Database]
TO DISK = N'$BackupFile'
WITH INIT, COMPRESSION = $CompressionOption
"@
    Invoke-Sqlcmd -ServerInstance $ServerInstance -Username $SaUserName -Password $SaPassword -Query $BackupQuery

    if (Test-Path $BackupFile) {
        # Move backup to destination
        Move-Item -Path $BackupFile -Destination (Join-Path $VolumeFolder "$Database.bak")
    } else {
        Write-Error "Backup file for $Database was not created!"
    }

    Write-Output "Setting database $Database offline"
    Invoke-Sqlcmd -ServerInstance $ServerInstance -Username $SaUserName -Password $SaPassword -Query "ALTER DATABASE [$Database] SET OFFLINE WITH ROLLBACK IMMEDIATE"
}

# Backup databases
BackupDatabase $AN_Database

{% if not ADC_NetworkInventory %}
BackupDatabase $AD_Database
{% endif %}

# Cleanup
Remove-Item $TempFolder -Recurse -Force
Start-Sleep -Seconds 15 # Wait for flush
