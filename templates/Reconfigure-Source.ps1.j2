################################################################
#                  CONFIGURATION SECTION                       #
################################################################

$AN_SQLDatabase      = "{{ database_list | select('search', 'Navigator') | first }}"
$SQLServerInstance   = "{{ new_hostname }},51967"
$AN_AccessKeyName    = "$SQLServerInstance : $AN_SQLDatabase"
$SaUser              = "{{ dest_SaUserName }}"
$SaPassword          = "{{ dest_SaPassword }}"


################################################################
#                      MAIN SCRIPT                             #
################################################################
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
    Install-PackageProvider -Name NuGet -Force
}

if ((Get-PSRepository PSGallery).InstallationPolicy -ne 'Trusted') {
    Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
}

if (-not (Get-Module -ListAvailable -Name SqlServer)) {
    Install-Module -Name SqlServer -Scope AllUsers -Force -AllowClobber
}


Import-Module SqlServer -ErrorAction Stop

$SecurePass = ConvertTo-SecureString $SaPassword -AsPlainText -Force
$Cred       = New-Object System.Management.Automation.PSCredential ($SaUser, $SecurePass)

{% for db in database_list %}
Write-Host "=== Processing database: {{ db }} ==="

# -------------------------------
# Restore database
# -------------------------------
$decrypted = C:\Install\ScriptHelper.exe DecryptAccessKey "D:\RegFiles\{{ db }}.reg"

$password = (($decrypted -split '`n' | where {$_ -like "Password*"}) -split ': ')[1]

$restoreSql = @"
DECLARE @DataPath NVARCHAR(260);
DECLARE @LogPath  NVARCHAR(260);
DECLARE @Sql NVARCHAR(MAX);

SELECT
    @DataPath = CAST(SERVERPROPERTY('InstanceDefaultDataPath') AS NVARCHAR(260)),
    @LogPath  = CAST(SERVERPROPERTY('InstanceDefaultLogPath')  AS NVARCHAR(260));

SET @Sql = N'
RESTORE DATABASE [{{ db }}]
FROM DISK = ''{{ target_mssql_backup_path }}\{{ db }}.bak''
WITH
    MOVE ''{{ db }}''     TO ''' + @DataPath + '{{ db }}.mdf'',
    MOVE ''{{ db }}_log'' TO ''' + @LogPath  + '{{ db }}_log.ldf'',
    REPLACE,
    STATS = 5;
';

EXEC (@Sql);

IF DB_ID('{{ db }}') IS NOT NULL
BEGIN
    ALTER DATABASE [{{ db }}] SET ONLINE;
    ALTER DATABASE [{{ db }}] SET MULTI_USER WITH ROLLBACK IMMEDIATE;
END
"@

Invoke-Sqlcmd -ServerInstance $SQLServerInstance `
              -Credential $Cred `
              -Database master `
              -Query $restoreSql

# -------------------------------
# Create / update logins
# -------------------------------
$loginSql = @"
IF NOT EXISTS (SELECT 1 FROM sys.sql_logins WHERE name = 'dbreader')
    CREATE LOGIN [dbreader]
        WITH PASSWORD = '{{ db_reader_password }}', CHECK_POLICY = OFF;
ELSE
    ALTER LOGIN [dbreader]
        WITH PASSWORD = '{{ db_reader_password }}', CHECK_POLICY = OFF;

GRANT CONNECT SQL TO [dbreader];

IF NOT EXISTS (SELECT 1 FROM sys.sql_logins WHERE name = '{{ db }}Access')
    CREATE LOGIN [{{ db }}Access]
        WITH PASSWORD = '$password',
             CHECK_POLICY = OFF;
ELSE
    ALTER LOGIN [{{ db }}Access]
        WITH PASSWORD = '$password',
             CHECK_POLICY = OFF;

GRANT CONNECT SQL TO [{{ db }}Access];
GRANT VIEW ANY DEFINITION TO [{{ db }}Access];
GRANT VIEW SERVER STATE TO [{{ db }}Access];
"@

Invoke-Sqlcmd -ServerInstance $SQLServerInstance `
              -Credential $Cred `
              -Database master `
              -Query $loginSql

# -------------------------------
# Create database users + perms
# -------------------------------
$userSql = @"
USE [{{ db }}];

IF EXISTS (SELECT 1 FROM sys.database_principals WHERE name = N'{{ db }}Access')
    DROP USER [{{ db }}Access];
CREATE USER [{{ db }}Access] FOR LOGIN [{{ db }}Access];

IF EXISTS (SELECT 1 FROM sys.database_principals WHERE name = N'dbreader')
    DROP USER [dbreader];
CREATE USER [dbreader] FOR LOGIN [dbreader];

ALTER ROLE [db_owner]      ADD MEMBER [{{ db }}Access];
ALTER ROLE [db_datareader] ADD MEMBER [dbreader];

DENY INSERT, UPDATE, DELETE TO [dbreader];
"@

Invoke-Sqlcmd -ServerInstance $SQLServerInstance `
              -Credential $Cred `
              -Database "{{ db }}" `
              -Query $userSql

{% endfor %}

reg import ("D:\RegFiles\" + $AN_SQLDatabase + ".reg")
reg import D:\RegFiles\an_service_connection.reg
reg import D:\RegFiles\user_connection.reg

{% if not ProductIsExpress%}
reg import D:\RegFiles\AlloyDiscoevry.reg
reg import D:\RegFiles\ad_service_connection.reg
{% endif %}

Invoke-Command -ArgumentList ($AN_AccessKeyName, $SQLServerInstance, $AN_SQLDatabase)  {
  param($AN_AccessKeyName, $SQLServerInstance, $AN_SQLDatabase)

  function UpdateWebConfig($InstallPath) {
      $FileName = "$InstallPath\Web.config"
      [xml]$xml = Get-Content -Path $FileName
      ($xml.configuration.appSettings.add | Where-Object { $_.key -eq "KeyName" }).value = $AN_AccessKeyName
      ($xml.configuration.appSettings.add | Where-Object { $_.key -eq "SQLServer" }).value = $SQLServerInstance
      ($xml.configuration.appSettings.add | Where-Object { $_.key -eq "Database" }).value = $AN_SQLDatabase
      $xml.Save($FileName)
  }

  function UpdateAppSettings($InstallPath) {
      $FileName = "$InstallPath\appsettings.json"
      $json = Get-Content -Path $FileName -Raw | ConvertFrom-Json
      $json.Anit."KeyName" = $AN_AccessKeyName
      $json.Anit."SQLServer" = $SQLServerInstance
      $json.Anit."Database" = $AN_SQLDatabase
      $json | ConvertTo-Json -Depth 10 | Set-Content -Path $FileName -Encoding UTF8
  }

  $DefaultsID = @(
      '{E850F970-051E-4B64-82CC-A1BF5324C370}',
      '{1766B1CF-887E-46C7-A9A0-4E204BEBC4F3}',
      '{031C27A5-6012-41B6-9EE0-459CF920A3DF}',
      '{C685B83D-C7C5-48F2-A509-CB4B048E7F1D}',
      '{85FFA55B-C1CE-454C-B111-F83EFAE376FE}',
      '{DD41C119-1E29-4814-9024-AB5B0D3AD00C}')

  Write-Output "Configuring web-portal SSP"
  Get-ChildItem "HKLM:\SOFTWARE\Alloy Software\Web Config" |
      Where-Object { $DefaultsID -notcontains $_.PSChildName } |
      ForEach-Object { UpdateAppSettings $_.GetValue("InstallPath") }

  Write-Output "Configuring web-portal API"
  Get-ChildItem "HKLM:\SOFTWARE\Alloy Software\Web Config API" |
      Where-Object { $DefaultsID -notcontains $_.PSChildName } |
      ForEach-Object { UpdateWebConfig $_.GetValue("InstallPath") }

  Write-Output "Configuring web-portal TP"
  Get-ChildItem "HKLM:\SOFTWARE\Alloy Software\Web Config Tech" |
      Where-Object { $DefaultsID -notcontains $_.PSChildName } |
      ForEach-Object { UpdateWebConfig $_.GetValue("InstallPath") }
}
