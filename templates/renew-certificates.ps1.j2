# Certificate renewal script for win-acme
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

$ErrorActionPreference = "Stop"

# Paths
$WinAcmePath = "{{ win_acme_install_path }}"
$WacsExe = Join-Path $WinAcmePath "wacs.exe"
$ConfigPath = "{{ win_acme_config_path }}"
$LogPath = Join-Path $ConfigPath "logs"

# Create log directory if it doesn't exist
if (-not (Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force | Out-Null
}

$LogFile = Join-Path $LogPath "renewal-$(Get-Date -Format 'yyyy-MM-dd-HHmm').log"

# Function to write logs
function Write-Log {
    param([string]$Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$Timestamp - $Message" | Out-File -FilePath $LogFile -Append -Encoding UTF8
}

try {
    Write-Log "Starting certificate renewal process"

    # Run win-acme in renew mode
    & $WacsExe --renew --baseuri "https://acme-v02.api.letsencrypt.org/" `
               --verbose `
               --config "{{ win_acme_config_path }}\settings.config"

    $ExitCode = $LASTEXITCODE

    if ($ExitCode -eq 0) {
        Write-Log "Certificate renewal completed successfully"

        # Optional: Restart services that use certificates
        # Restart-Service -Name "IISADMIN" -Force -ErrorAction SilentlyContinue
        # Write-Log "IIS service restarted"

    } elseif ($ExitCode -eq 1) {
        Write-Log "Certificate renewal completed with warnings"
    } else {
        Write-Log "Certificate renewal failed with exit code: $ExitCode"
        exit 1
    }

} catch {
    Write-Log "Error during certificate renewal: $_"
    exit 1
}

Write-Log "Renewal process completed"