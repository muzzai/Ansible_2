- name: Add ingress rules
  hosts: "{{ host }}"
  vars:
    sg_id: "{{ configured_sg_id if configured_sg_id is defined else hostvars['security_groups'][0]['group_id'] }}"
    host: "{{ configured_host | default('aws_ec2') }}"
  tasks:
    - name: Validate new_inbound_rules variable
      ansible.builtin.fail:
        msg: "new_inbound_rules must be a valid list with at least one rule"
      when:
        - new_inbound_rules is not defined
        - or new_inbound_rules | length == 0
        - or new_inbound_rules is not iterable

    - name: Validate each rule in new_inbound_rules
      ansible.builtin.fail:
        msg: "Rule {{ item }} is missing required fields: proto, ports, cidr_ip"
      loop: "{{ new_inbound_rules }}"
      when: >
        item.proto is not defined or
        item.ports is not defined or
        item.cidr_ip is not defined

    - name: Get current security group info
      amazon.aws.ec2_security_group_info:
        filters:
          group-id: "{{ sg_id }}"
          vpc-id: "{{ vpc_id }}"
          region: "{{ aws_region }}"
      register: sg_info
      delegate_to: localhost

    - name: Combine existing inbound rules with new rules
      ansible.builtin.set_fact:
        combined_inbound_rules: "{{ sg_info.security_groups[0].ip_permissions + new_inbound_rules }}"

    - name: Ensure security group for instance exists
      amazon.aws.ec2_security_group:
        name: "{{ sg_id }}"
        region: "{{ aws_region }}"
        rules: "{{ combined_inbound_rules }}"
      delegate_to: localhost
